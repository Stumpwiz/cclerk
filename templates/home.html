{% extends 'base.html' %}
{% block title %}Home{% endblock %}
{% block content %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Set up report buttons to navigate to their respective routes
            document.getElementById('btn_long_form').addEventListener('click', function() {
                // Disable the button to prevent multiple clicks
                this.disabled = true;
                const originalText = this.innerHTML;
                this.innerHTML = 'Generating...';

                // Make AJAX request to generate the PDF
                fetch('/report/long', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = originalText;

                    if (data.success) {
                        const filename = data.filename;
                        const filesList = document.getElementById('pdfFilesList');

                        // Check if the file is already in the list
                        let fileItem = null;
                        let fileExists = false;
                        const fileItems = filesList.querySelectorAll('a');

                        fileItems.forEach(function(item) {
                            if (item.textContent.trim() === filename) {
                                fileItem = item;
                                fileExists = true;
                            }
                        });

                        // If the file doesn't exist in the list, add it
                        if (!fileExists) {
                            fileItem = document.createElement('a');
                            fileItem.href = '#';
                            fileItem.className = 'list-group-item list-group-item-action';
                            fileItem.textContent = filename;
                            filesList.appendChild(fileItem);

                            // Add click event listener to the new file item
                            fileItem.addEventListener('click', function(e) {
                                e.preventDefault();
                                // Remove the active class from all items
                                filesList.querySelectorAll('a').forEach(function(i) {
                                    i.classList.remove('active');
                                });
                                // Add active class to clicked item
                                this.classList.add('active');
                                // Update the hidden input field for the View form
                                document.getElementById('view_pdf_file').value = this.textContent.trim();
                            });
                        }

                        // Select the file in the list
                        filesList.querySelectorAll('a').forEach(function(i) {
                            i.classList.remove('active');
                        });
                        fileItem.classList.add('active');

                        // Update the hidden input field for the View form
                        document.getElementById('view_pdf_file').value = filename;
                    } else {
                        // Show the error message
                        alert('Failed to generate PDF: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = originalText;

                    // Show the error message
                    alert('Failed to generate PDF: ' + error);
                });
            });

            document.getElementById('btn_short_form').addEventListener('click', function() {
                // Disable the button to prevent multiple clicks
                this.disabled = true;
                const originalText = this.innerHTML;
                this.innerHTML = 'Generating...';

                // Make AJAX request to generate the PDF
                fetch('/report/short', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = originalText;

                    if (data.success) {
                        const filename = data.filename;
                        const filesList = document.getElementById('pdfFilesList');

                        // Check if the file is already in the list
                        let fileItem = null;
                        let fileExists = false;
                        const fileItems = filesList.querySelectorAll('a');

                        fileItems.forEach(function(item) {
                            if (item.textContent.trim() === filename) {
                                fileItem = item;
                                fileExists = true;
                            }
                        });

                        // If the file doesn't exist in the list, add it
                        if (!fileExists) {
                            fileItem = document.createElement('a');
                            fileItem.href = '#';
                            fileItem.className = 'list-group-item list-group-item-action';
                            fileItem.textContent = filename;
                            filesList.appendChild(fileItem);

                            // Add click event listener to the new file item
                            fileItem.addEventListener('click', function(e) {
                                e.preventDefault();
                                // Remove the active class from all items
                                filesList.querySelectorAll('a').forEach(function(i) {
                                    i.classList.remove('active');
                                });
                                // Add active class to clicked item
                                this.classList.add('active');
                                // Update the hidden input field for the View form
                                document.getElementById('view_pdf_file').value = this.textContent.trim();
                            });
                        }

                        // Select the file in the list
                        filesList.querySelectorAll('a').forEach(function(i) {
                            i.classList.remove('active');
                        });
                        fileItem.classList.add('active');

                        // Update the hidden input field for the View form
                        document.getElementById('view_pdf_file').value = filename;
                    } else {
                        // Show the error message
                        alert('Failed to generate PDF: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = originalText;

                    // Show the error message
                    alert('Failed to generate PDF: ' + error);
                });
            });

            document.getElementById('btn_vacancies').addEventListener('click', function() {
                // Disable the button to prevent multiple clicks
                this.disabled = true;
                const originalText = this.innerHTML;
                this.innerHTML = 'Generating...';

                // Make AJAX request to generate the PDF
                fetch('/report/vacancies', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = originalText;

                    if (data.success) {
                        const filename = data.filename;
                        const filesList = document.getElementById('pdfFilesList');

                        // Check if the file is already in the list
                        let fileItem = null;
                        let fileExists = false;
                        const fileItems = filesList.querySelectorAll('a');

                        fileItems.forEach(function(item) {
                            if (item.textContent.trim() === filename) {
                                fileItem = item;
                                fileExists = true;
                            }
                        });

                        // If the file doesn't exist in the list, add it
                        if (!fileExists) {
                            fileItem = document.createElement('a');
                            fileItem.href = '#';
                            fileItem.className = 'list-group-item list-group-item-action';
                            fileItem.textContent = filename;
                            filesList.appendChild(fileItem);

                            // Add click event listener to the new file item
                            fileItem.addEventListener('click', function(e) {
                                e.preventDefault();
                                // Remove the active class from all items
                                filesList.querySelectorAll('a').forEach(function(i) {
                                    i.classList.remove('active');
                                });
                                // Add active class to clicked item
                                this.classList.add('active');
                                // Update the hidden input field for the View form
                                document.getElementById('view_pdf_file').value = this.textContent.trim();
                            });
                        }

                        // Select the file in the list
                        filesList.querySelectorAll('a').forEach(function(i) {
                            i.classList.remove('active');
                        });
                        fileItem.classList.add('active');

                        // Update the hidden input field for the View form
                        document.getElementById('view_pdf_file').value = filename;
                    } else {
                        // Show the error message
                        alert('Failed to generate PDF: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = originalText;

                    // Show the error message
                    alert('Failed to generate PDF: ' + error);
                });
            });

            document.getElementById('btn_expiring').addEventListener('click', function() {
                // Disable the button to prevent multiple clicks
                this.disabled = true;
                const originalText = this.innerHTML;
                this.innerHTML = 'Generating...';

                // Make AJAX request to generate the PDF
                fetch('/report/expirations', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = originalText;

                    if (data.success) {
                        const filename = data.filename;
                        const filesList = document.getElementById('pdfFilesList');

                        // Check if the file is already in the list
                        let fileItem = null;
                        let fileExists = false;
                        const fileItems = filesList.querySelectorAll('a');

                        fileItems.forEach(function(item) {
                            if (item.textContent.trim() === filename) {
                                fileItem = item;
                                fileExists = true;
                            }
                        });

                        // If the file doesn't exist in the list, add it
                        if (!fileExists) {
                            fileItem = document.createElement('a');
                            fileItem.href = '#';
                            fileItem.className = 'list-group-item list-group-item-action';
                            fileItem.textContent = filename;
                            filesList.appendChild(fileItem);

                            // Add click event listener to the new file item
                            fileItem.addEventListener('click', function(e) {
                                e.preventDefault();
                                // Remove the active class from all items
                                filesList.querySelectorAll('a').forEach(function(i) {
                                    i.classList.remove('active');
                                });
                                // Add active class to clicked item
                                this.classList.add('active');
                                // Update the hidden input field for the View form
                                document.getElementById('view_pdf_file').value = this.textContent.trim();
                            });
                        }

                        // Select the file in the list
                        filesList.querySelectorAll('a').forEach(function(i) {
                            i.classList.remove('active');
                        });
                        fileItem.classList.add('active');

                        // Update the hidden input field for the View form
                        document.getElementById('view_pdf_file').value = filename;
                    } else {
                        // Show the error message
                        alert('Failed to generate PDF: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = originalText;

                    // Show the error message
                    alert('Failed to generate PDF: ' + error);
                });
            });

            // Find all buttons
            const buttons = document.querySelectorAll('button.btn-primary');

            // Find the backup and restore buttons by their text content
            let backupButton = null;
            let restoreButton = null;
            buttons.forEach(function (button) {
                if (button.textContent.trim() === 'Backup') {
                    backupButton = button;
                } else if (button.textContent.trim() === 'Restore') {
                    restoreButton = button;
                }
            });

            // Add click event listener to the backup button
            if (backupButton) {
                backupButton.addEventListener('click', function () {
                    // Show the loading indicator or disable button
                    this.disabled = true;
                    this.innerHTML = 'Backing up...';

                    // Make AJAX request to backup endpoint
                    fetch('/backup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Re-enable button
                            this.disabled = false;
                            this.innerHTML = 'Backup';

                            if (data.success) {
                                // Add the new backup file to the list
                                const filesList = document.getElementById('backupFilesList');
                                const fileItem = document.createElement('a');
                                fileItem.href = '#';
                                fileItem.className = 'list-group-item list-group-item-action';
                                fileItem.textContent = data.filename;
                                filesList.appendChild(fileItem);

                                // Add click event listener to the new file item
                                fileItem.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    // Remove the active class from all items
                                    document.querySelectorAll('#backupFilesList a').forEach(function (i) {
                                        i.classList.remove('active');
                                    });
                                    // Add active class to clicked item
                                    this.classList.add('active');
                                    // Update the hidden input field for the View form
                                    document.getElementById('view_sql_file').value = this.textContent.trim();
                                });

                                // Show the success message
                                alert('Backup created successfully: ' + data.filename);
                            } else {
                                // Show the error message
                                alert('Backup failed: ' + data.error);
                            }
                        })
                        .catch(error => {
                            // Re-enable button
                            this.disabled = false;
                            this.innerHTML = 'Backup';

                            // Show the error message
                            alert('Backup failed: ' + error);
                        });
                });
            }

            // Add click event listener to the restore button
            if (restoreButton) {
                restoreButton.addEventListener('click', function () {
                    // Get the selected file from the list
                    const filesList = document.getElementById('backupFilesList');
                    const selectedFile = filesList.querySelector('.active');

                    // Check if a file is selected
                    if (!selectedFile) {
                        alert('Please select a SQL file to restore from');
                        return;
                    }

                    // Confirm restoration
                    if (!confirm('Are you sure you want to restore the database from this backup? This will overwrite the current database and cannot be undone.')) {
                        return;
                    }

                    // Show the loading indicator or disable button
                    this.disabled = true;
                    this.innerHTML = 'Restoring...';

                    // Make AJAX request to restore endpoint
                    fetch('/restore', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: selectedFile.textContent.trim()
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Re-enable button
                            this.disabled = false;
                            this.innerHTML = 'Restore';

                            if (data.success) {
                                // Show the success message
                                alert('Database restored successfully from: ' + selectedFile.textContent.trim());
                            } else {
                                // Show the error message
                                alert('Restore failed: ' + data.error);
                            }
                        })
                        .catch(error => {
                            // Re-enable button
                            this.disabled = false;
                            this.innerHTML = 'Restore';

                            // Show the error message
                            alert('Restore failed: ' + error);
                        });
                });
            }


            // Make backup files list items selectable
            const backupFileItems = document.querySelectorAll('#backupFilesList a');

            // Select the first item by default if there are any items
            if (backupFileItems.length > 0) {
                backupFileItems[0].classList.add('active');
                // Update the hidden input field for the View form with the first SQL file
                document.getElementById('view_sql_file').value = backupFileItems[0].textContent.trim();
            }

            backupFileItems.forEach(function (item) {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    // Remove the active class from all items
                    backupFileItems.forEach(function (i) {
                        i.classList.remove('active');
                    });
                    // Add active class to clicked item
                    this.classList.add('active');
                    // Update the hidden input field for the View form
                    document.getElementById('view_sql_file').value = this.textContent.trim();
                });
            });


            // Make PDF files list items selectable
            const pdfFileItems = document.querySelectorAll('#pdfFilesList a');

            // Select the first item by default if there are any items
            if (pdfFileItems.length > 0) {
                pdfFileItems[0].classList.add('active');
                // Update the hidden input field for the View form with the first PDF file
                document.getElementById('view_pdf_file').value = pdfFileItems[0].textContent.trim();
            }

            pdfFileItems.forEach(function (item) {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    // Remove the active class from all items
                    pdfFileItems.forEach(function (i) {
                        i.classList.remove('active');
                    });
                    // Add active class to clicked item
                    this.classList.add('active');
                    // Update the hidden input field for the View form
                    document.getElementById('view_pdf_file').value = this.textContent.trim();
                });
            });

            // Add an event handler for the View PDF button
            const viewPdfButton = document.getElementById('btn_view_pdf');
            if (viewPdfButton) {
                // Get the form that contains the button
                const viewPdfForm = viewPdfButton.closest('form');

                // Add an event listener to the form's "submit" event
                viewPdfForm.addEventListener('submit', function (e) {
                    // Always prevent the default form submission first
                    e.preventDefault();

                    // Get the selected file from the list
                    const filesList = document.getElementById('pdfFilesList');
                    const selectedFile = filesList.querySelector('.active');

                    // Check if a file is selected
                    if (!selectedFile) {
                        alert('Please select a PDF file to view');
                        return;
                    }

                    // Set the value of the hidden input field to the selected file
                    document.getElementById('view_pdf_file').value = selectedFile.textContent.trim();

                    // Now manually submit the form
                    viewPdfForm.submit();
                });
            }

            // Add an event handler for the Delete PDF button
            const deletePdfButton = document.getElementById('btn_delete_pdf');
            if (deletePdfButton) {
                deletePdfButton.addEventListener('click', function () {
                    // Get the selected file from the list
                    const filesList = document.getElementById('pdfFilesList');
                    const selectedFile = filesList.querySelector('.active');

                    // Check if a file is selected
                    if (!selectedFile) {
                        alert('Please select a PDF file to delete');
                        return;
                    }

                    // Confirm deletion
                    if (!confirm('Are you sure you want to delete this PDF? This action cannot be undone.')) {
                        return;
                    }

                    // Show the loading indicator or disable button
                    this.disabled = true;
                    const originalText = this.innerHTML;
                    this.innerHTML = 'Deleting...';

                    // Make AJAX request to delete_file endpoint
                    fetch('/delete_file', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: selectedFile.textContent.trim()
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Re-enable button
                            this.disabled = false;
                            this.innerHTML = originalText;

                            if (data.success) {
                                // Remove the file from the list
                                selectedFile.remove();

                                // Select the first item if available
                                if (filesList.children.length > 0) {
                                    filesList.children[0].classList.add('active');
                                    // Update the hidden input field for the View form
                                    document.getElementById('view_pdf_file').value = filesList.children[0].textContent.trim();
                                } else {
                                    // Clear the hidden input field if no files are left
                                    document.getElementById('view_pdf_file').value = '';
                                }

                                // Show the success message
                                alert('File deleted successfully');
                            } else {
                                // Show the error message
                                alert('Failed to delete file: ' + data.error);
                            }
                        })
                        .catch(error => {
                            // Re-enable button
                            this.disabled = false;
                            this.innerHTML = originalText;

                            // Show the error message
                            alert('Failed to delete file: ' + error);
                        });
                });
            }

            // Add an event handler for the View SQL button
            const viewSqlButton = document.getElementById('btn_view_sql');
            if (viewSqlButton) {
                viewSqlButton.addEventListener('click', function (e) {
                    // Get the selected file from the list
                    const filesList = document.getElementById('backupFilesList');
                    const selectedFile = filesList.querySelector('.active');
                    const hiddenInput = document.getElementById('view_sql_file');

                    // Check if a file is selected
                    if (!selectedFile) {
                        e.preventDefault(); // Prevent form submission
                        alert('Please select a SQL file to view');
                        return;
                    }

                    // Check if the hidden input field has a value
                    if (!hiddenInput.value) {
                        e.preventDefault(); // Prevent form submission
                        alert('No SQL file selected');
                        return;
                    }

                    // Set the value of the hidden input field to the selected file
                    hiddenInput.value = selectedFile.textContent.trim();
                });
            }

            // Add an event handler for the Delete SQL button
            const deleteSqlButton = document.getElementById('btn_delete_sql');
            if (deleteSqlButton) {
                deleteSqlButton.addEventListener('click', function () {
                    // Get the selected file from the list
                    const filesList = document.getElementById('backupFilesList');
                    const selectedFile = filesList.querySelector('.active');

                    // Check if a file is selected
                    if (!selectedFile) {
                        alert('Please select a SQL file to delete');
                        return;
                    }

                    // Confirm deletion
                    if (!confirm('Are you sure you want to delete this SQL file? This action cannot be undone.')) {
                        return;
                    }

                    // Show the loading indicator or disable button
                    this.disabled = true;
                    const originalText = this.innerHTML;
                    this.innerHTML = 'Deleting...';

                    // Make AJAX request to delete_file endpoint
                    fetch('/delete_file', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: selectedFile.textContent.trim()
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Re-enable button
                            this.disabled = false;
                            this.innerHTML = originalText;

                            if (data.success) {
                                // Remove the file from the list
                                selectedFile.remove();

                                // Select the first item if available
                                if (filesList.children.length > 0) {
                                    filesList.children[0].classList.add('active');
                                    // Update the hidden input field for the View form
                                    document.getElementById('view_sql_file').value = filesList.children[0].textContent.trim();
                                } else {
                                    // Clear the hidden input field if no files are left
                                    document.getElementById('view_sql_file').value = '';
                                }

                                // Show the success message
                                alert('File deleted successfully');
                            } else {
                                // Show the error message
                                alert('Failed to delete file: ' + data.error);
                            }
                        })
                        .catch(error => {
                            // Re-enable button
                            this.disabled = false;
                            this.innerHTML = originalText;

                            // Show the error message
                            alert('Failed to delete file: ' + error);
                        });
                });
            }
        });
    </script>
    <style>
        .full-height-container {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 150px); /* Adjust based on navbar and other elements */
        }

        .full-height-row {
            flex: 1;
        }

        .full-height-card {
            height: 100%;
        }
    </style>
    <div class="container full-height-container">
        <div class="row full-height-row">
            <!-- Left Column - Generate Reports -->
            <div id="reports_column" class="col-md-6">
                <div class="card mb-4 full-height-card">
                    <div class="card-header">
                        <h3>Refresh and View Reports</h3>
                    </div>
                    <div class="card-body" style="min-height: 300px;">
                        <div class="row h-100">
                            <!-- Left Column - Buttons -->
                            <div class="col-md-6">
                                <div class="d-flex flex-column justify-content-start h-100">
                                    <button type="button" id="btn_expiring" class="btn btn-primary mb-3">Expiring Terms</button>
                                    <button type="button" id="btn_long_form" class="btn btn-primary mb-3">Long Form Roster</button>
                                    <button type="button" id="btn_short_form" class="btn btn-primary mb-3">Short Form Roster</button>
                                    <button type="button" id="btn_vacancies" class="btn btn-primary mb-3">Vacancies</button>
                                </div>
                            </div>

                            <!-- Right Column - Display Window -->
                            <div class="col-md-6 h-100">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5>Available Reports</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="pdfFilesList" class="list-group mb-3">
                                            <!-- PDF files will be displayed here -->
                                            {% for file in pdf_files %}
                                                <a href="#"
                                                   class="list-group-item list-group-item-action">{{ file }}</a>
                                            {% endfor %}
                                        </div>
                                        <!-- Action Buttons -->
                                        <div class="row">
                                            <div class="col-6 mb-2">
                                                <form method="POST" action="{{ url_for('main.view_pdf') }}"
                                                      target="_blank">
                                                    <input type="hidden" id="view_pdf_file" name="pdf_file" value="">
                                                    <button type="submit" id="btn_view_pdf"
                                                            class="btn btn-sm btn-primary w-100">View
                                                    </button>
                                                </form>
                                            </div>
                                            <div class="col-6">
                                                <button type="button" id="btn_delete_pdf"
                                                        class="btn btn-sm btn-danger w-100">Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Backup/Restore -->
            <div id="backup_column" class="col-md-6">
                <div class="card mb-4 full-height-card">
                    <div class="card-header">
                        <h3>Backup/Restore Database</h3>
                    </div>
                    <div class="card-body" style="min-height: 300px;">
                        <div class="row h-100">
                            <!-- Left Column - Buttons -->
                            <div class="col-md-6">
                                <div class="d-flex flex-column justify-content-start h-100">
                                    <button type="button" class="btn btn-primary mb-3">Backup</button>
                                    <button type="button" class="btn btn-primary mb-3">Restore</button>
                                </div>
                            </div>

                            <!-- Right Column - Display Window -->
                            <div class="col-md-6 h-100">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5>Generated Backups</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="backupFilesList" class="list-group mb-3">
                                            <!-- Files will be displayed here -->
                                            {% for file in backup_files %}
                                                <a href="#"
                                                   class="list-group-item list-group-item-action">{{ file }}</a>
                                            {% endfor %}
                                        </div>
                                        <!-- Action Buttons -->
                                        <div class="row">
                                            <div class="col-6 mb-2">
                                                <form method="POST" action="{{ url_for('main.view_sql') }}"
                                                      target="_blank">
                                                    <input type="hidden" id="view_sql_file" name="sql_file" value="">
                                                    <button type="submit" id="btn_view_sql"
                                                            class="btn btn-sm btn-primary w-100">View
                                                    </button>
                                                </form>
                                            </div>
                                            <div class="col-6">
                                                <button type="button" id="btn_delete_sql"
                                                        class="btn btn-sm btn-danger w-100">Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
